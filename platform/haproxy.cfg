global
    maxconn 4096
    log stdout format raw local0
    stats timeout 30s

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Frontend for API Gateway
frontend http-in
    bind *:8009
    default_backend l09-api-gateway

    # Access control
    acl network_allowed src 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.1
    http-request deny if !network_allowed

    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

# Frontend for Platform UI
frontend ui-in
    bind *:3000
    default_backend platform-ui

# Backend for L09 API Gateway (with multiple replicas)
backend l09-api-gateway
    balance roundrobin
    option httpchk GET /health/live
    http-check expect status 200

    # Health check configuration
    default-server inter 2000 rise 2 fall 3 on-marked-down shutdown-sessions

    # Replica servers (add more as needed)
    server l09-1 l09-api-gateway:8009 check
    # Uncomment for HA with multiple replicas:
    # server l09-2 l09-api-gateway-2:8009 check
    # server l09-3 l09-api-gateway-3:8009 check

# Backend for Platform UI
backend platform-ui
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    default-server inter 2000 rise 2 fall 3

    server ui-1 platform-ui:80 check
    # Uncomment for HA with multiple replicas:
    # server ui-2 platform-ui-2:80 check

# HAProxy Statistics
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
    stats auth admin:admin  # Change in production
    stats show-legends

# Health check endpoint
frontend health
    bind *:8405
    mode http
    monitor-uri /health
    acl site_dead nbsrv(l09-api-gateway) lt 1
    acl site_dead nbsrv(platform-ui) lt 1
    monitor fail if site_dead
