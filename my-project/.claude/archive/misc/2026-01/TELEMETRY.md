# Telemetry Setup for Story Portal Development

This project includes telemetry configuration to track token usage and costs during agent-assisted development.

## Quick Start

### Option 1: Use the helper script (recommended)
```bash
./enable-telemetry.sh
```

This will:
1. Source the telemetry configuration
2. Launch Claude Code with metrics enabled
3. Display token metrics in your console every 10 seconds

### Option 2: Manual setup
```bash
source .env.telemetry
claude
```

## What You'll See

When telemetry is enabled, you'll see token metrics output approximately every 10 seconds:

```
{
  "resourceMetrics": [
    {
      "resource": {
        "attributes": {
          "service.name": "claude-code"
        }
      },
      "scopeMetrics": [
        {
          "metrics": [
            {
              "name": "claude_code.token.usage",
              "type": "SUM",
              "dataPoints": [
                {
                  "attributes": {
                    "type": "input",
                    "model": "claude-opus-4-5-20251101"
                  },
                  "value": 1500
                },
                {
                  "attributes": {
                    "type": "output",
                    "model": "claude-opus-4-5-20251101"
                  },
                  "value": 850
                },
                {
                  "attributes": {
                    "type": "cacheRead",
                    "model": "claude-opus-4-5-20251101"
                  },
                  "value": 200
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

## Key Metrics to Track

| Metric | Meaning | Target |
|--------|---------|--------|
| `input` | Tokens sent to Claude | Lower is better |
| `output` | Tokens generated by Claude | Expected to vary |
| `cacheRead` | Tokens reused from cache | Higher = better optimization |
| `cacheCreation` | Tokens written to cache | One-time cost |

## During a Session

### Check current cost
Use the `/cost` command at any time:
```
/cost
```

This shows:
- Total USD cost so far
- API duration
- Wall-clock time
- Lines of code changed

### Manual compaction
To see immediate token savings:
```
/compact Focus on code changes and test results
```

The next request should show lower `input` tokens due to context compression.

## Benchmarking Workflow

1. **Start session with telemetry enabled** (this script)
2. **Perform your work** (specs, implementation, etc.)
3. **Check `/cost`** periodically to track spending
4. **Run `/compact`** between major phases to see optimization benefit
5. **Review console output** for token metric trends

## Configuration

Edit `.env.telemetry` to adjust:

```bash
# Export interval (milliseconds)
export OTEL_METRIC_EXPORT_INTERVAL=10000  # Change to 5000 for more frequent updates

# Log level
export CLAUDE_CODE_LOG_LEVEL=debug  # Or 'info', 'warn', 'error'
```

## Advanced: Export to Prometheus or Datadog

For production monitoring, edit `.env.telemetry`:

**Prometheus**:
```bash
export OTEL_METRICS_EXPORTER=prometheus
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:8888  # Prometheus endpoint
```

**OTLP (Datadog/Honeycomb/Grafana)**:
```bash
export OTEL_METRICS_EXPORTER=otlp
export OTEL_EXPORTER_OTLP_ENDPOINT=http://your-collector:4317
```

## Costs & Usage

Telemetry does NOT affect your actual token usage—it only monitors and reports it. Enabling telemetry:
- ✅ Helps you understand token consumption
- ✅ Supports benchmarking optimization effectiveness
- ✅ Has minimal performance overhead
- ❌ Does NOT reduce your token usage (only monitoring)

To reduce actual tokens, use:
- `/compact` to summarize context
- `/clear` to start fresh between tasks
- Auto-compact (enabled by default) condenses context at 95% capacity

## Troubleshooting

**No metrics appearing?**
- Ensure you sourced `.env.telemetry` before running `claude`
- Check that `CLAUDE_CODE_ENABLE_TELEMETRY=1`
- Wait 10+ seconds for first metric export

**Metrics too verbose?**
- Increase `OTEL_METRIC_EXPORT_INTERVAL` (e.g., 30000 for 30 seconds)

**Want to disable temporarily?**
- Just run `claude` without sourcing `.env.telemetry`
- Or override: `export CLAUDE_CODE_ENABLE_TELEMETRY=0 && claude`

## More Resources

- [Claude Code Costs Documentation](https://code.claude.com/docs/en/costs.md)
- [Claude Code Monitoring Guide](https://code.claude.com/docs/en/monitoring-usage.md)
